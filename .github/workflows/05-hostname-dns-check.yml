name: 05 - Hostname + Managed Hosts + DNS/Ping Check (Enterprise)

on:
  workflow_dispatch:
    inputs:
      hosts_entries:
        description: "Comma separated ip:hostname entries for managed /etc/hosts block (e.g. 10.0.0.10:origin.local,10.0.0.11:api.local)"
        required: false
        default: ""
      dns_names:
        description: "Comma separated names to resolve/ping (e.g. google.com,origin.local)"
        required: false
        default: "google.com,cloudflare.com"
      tcp_targets:
        description: "Optional comma separated host:port for TCP check (e.g. 1.1.1.1:443,api.local:443)"
        required: false
        default: ""
      dry_run:
        description: "If true, do not change hostname/hosts; only report"
        required: false
        default: "false"

jobs:
  hostcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build remote bundle
        run: |
          set -euo pipefail
          mkdir -p /tmp/ec2mw
          cp -r scripts/remote /tmp/ec2mw/
          tar -czf /tmp/ec2mw.tgz -C /tmp ec2mw
          base64 /tmp/ec2mw.tgz > /tmp/ec2mw.tgz.b64

      - name: Upload remote bundle to all hosts
        env:
          EC2_HOSTS: ${{ secrets.EC2_HOSTS }}
          EC2_USER:  ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_PORT:  ${{ secrets.EC2_PORT }}
        run: |
          set -euo pipefail
          chmod +x scripts/runner/ssh_exec.sh scripts/runner/parse_hosts.sh
          scripts/runner/parse_hosts.sh "${EC2_HOSTS}" > /tmp/hosts.txt

          while read -r h; do
            echo "=== Upload bundle to: ${h} ==="
            scripts/runner/ssh_exec.sh "${h}" "sudo -n bash -lc 'mkdir -p /tmp/ec2mw && cat > /tmp/ec2mw.tgz.b64'" < /tmp/ec2mw.tgz.b64
            scripts/runner/ssh_exec.sh "${h}" "sudo -n bash -lc 'base64 -d /tmp/ec2mw.tgz.b64 > /tmp/ec2mw.tgz && tar -xzf /tmp/ec2mw.tgz -C /tmp && chmod +x /tmp/ec2mw/remote/*.sh'"
          done < /tmp/hosts.txt

      - name: Apply per-host hostname + managed hosts + DNS checks
        env:
          EC2_HOSTS: ${{ secrets.EC2_HOSTS }}
          EC2_USER:  ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          EC2_PORT:  ${{ secrets.EC2_PORT }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          set -euo pipefail
          chmod +x scripts/runner/ssh_exec.sh scripts/runner/parse_hosts.sh
          scripts/runner/parse_hosts.sh "${EC2_HOSTS}" > /tmp/hosts.txt

          HOST_MAP="inventory/hostnames.map"
          HOSTS_ENTRIES="${{ inputs.hosts_entries }}"
          DNS_NAMES="${{ inputs.dns_names }}"
          TCP_TARGETS="${{ inputs.tcp_targets }}"
          DRY_RUN="${{ inputs.dry_run }}"

          mkdir -p artifacts
          ok=0
          fail=0

          while read -r h; do
            hn="$(awk -v h="$h" '$1==h {print $2}' "${HOST_MAP}")"

            if [[ -z "${hn}" ]]; then
              echo "ERROR: No hostname mapping for host: ${h} in ${HOST_MAP}"
              fail=$((fail+1))
              continue
            fi

            echo "=============================="
            echo "TARGET: ${h}"
            echo "HOSTNAME: ${hn}"
            echo "=============================="

            if scripts/runner/ssh_exec.sh "${h}" "sudo -n bash -lc 'export NEW_HOSTNAME=${hn}; export HOSTS_ENTRIES=${HOSTS_ENTRIES}; export DNS_NAMES=${DNS_NAMES}; export TCP_TARGETS=${TCP_TARGETS}; export DRY_RUN=${DRY_RUN}; cp /tmp/ec2mw/remote/lib.sh /tmp/ec2mw/lib.sh; /tmp/ec2mw/remote/hostname_dns_check.sh'" \
              | tee "artifacts/${h}.log"
            then
              ok=$((ok+1))
            else
              fail=$((fail+1))
            fi

            awk '/^JSON_BEGIN$/{flag=1;next} /^JSON_END$/{flag=0} flag{print}' "artifacts/${h}.log" > "artifacts/${h}.json" || true
          done < /tmp/hosts.txt

          echo "OK=${ok}" > artifacts/summary.env
          echo "FAIL=${fail}" >> artifacts/summary.env

          # Slack notify (optional): only if webhook secret exists
          if [[ -n "${SLACK_WEBHOOK_URL:-}" ]]; then
            source artifacts/summary.env
            status="SUCCESS"
            color="good"
            if [[ "${FAIL}" != "0" ]]; then
              status="FAIL"
              color="danger"
            fi

            payload=$(cat <<JSON
{
  "text": "*EC2 Management â€“ Hostname/DNS Check* (${status})",
  "attachments": [
    {
      "color": "${color}",
      "fields": [
        { "title": "Success", "value": "${OK}", "short": true },
        { "title": "Failed",  "value": "${FAIL}", "short": true },
        { "title": "Dry run", "value": "${DRY_RUN}", "short": true }
      ]
    }
  ]
}
JSON
)
            curl -s -X POST -H 'Content-Type: application/json' --data "${payload}" "${SLACK_WEBHOOK_URL}" >/dev/null || true
          fi

      - name: Upload reports
        uses: actions/upload-artifact@v4
        with:
          name: hostname-dns-check-reports
          path: artifacts/
